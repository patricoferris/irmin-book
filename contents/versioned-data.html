<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Versioned Data - Real World Irmin</title>
        <!-- Custom HTML head -->
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../concepts.html"><strong aria-hidden="true">1.</strong> Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../intro/what-is-irmin.html"><strong aria-hidden="true">1.1.</strong> What is Irmin?</a></li><li class="chapter-item expanded "><a href="../intro/key-concepts.html"><strong aria-hidden="true">1.2.</strong> Key Concepts</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture.html"><strong aria-hidden="true">2.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../arch/functors.html"><strong aria-hidden="true">2.1.</strong> A primer on functors</a></li><li class="chapter-item expanded "><a href="../arch/schemas.html"><strong aria-hidden="true">2.2.</strong> Schemas</a></li><li class="chapter-item expanded "><a href="../arch/runtime-types.html"><strong aria-hidden="true">2.3.</strong> Runtime Types</a></li><li class="chapter-item expanded "><a href="../arch/backend.html"><strong aria-hidden="true">2.4.</strong> Backend Storage</a></li><li class="chapter-item expanded "><a href="../arch/portability.html"><strong aria-hidden="true">2.5.</strong> MirageOS-style Portability</a></li></ol></li><li class="chapter-item expanded "><a href="../store_contents.html"><strong aria-hidden="true">3.</strong> Contents of the Store</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../contents/mergeable-datatypes.html"><strong aria-hidden="true">3.1.</strong> Mergeable Datatypes</a></li><li class="chapter-item expanded "><a href="../contents/json-at-rest.html"><strong aria-hidden="true">3.2.</strong> JSON at Rest</a></li><li class="chapter-item expanded "><a href="../contents/versioned-data.html" class="active"><strong aria-hidden="true">3.3.</strong> Versioned Data</a></li></ol></li><li class="chapter-item expanded "><a href="../sync.html"><strong aria-hidden="true">4.</strong> Synchronisation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../sync/pull.html"><strong aria-hidden="true">4.1.</strong> Pulling remote data</a></li><li class="chapter-item expanded "><a href="../sync/push.html"><strong aria-hidden="true">4.2.</strong> Pushing Data</a></li></ol></li><li class="chapter-item expanded "><a href="../intf.html"><strong aria-hidden="true">5.</strong> Public Interfaces for Irmin Stores</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../intf/cli.html"><strong aria-hidden="true">5.1.</strong> Command-line Interface</a></li><li class="chapter-item expanded "><a href="../intf/graphql.html"><strong aria-hidden="true">5.2.</strong> GraphQL Interface</a></li><li class="chapter-item expanded "><a href="../intf/irmin-server.html"><strong aria-hidden="true">5.3.</strong> Irmin-server Interface</a></li></ol></li><li class="chapter-item expanded "><a href="../todo/intro.html"><strong aria-hidden="true">6.</strong> Mergeable TODO application</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Real World Irmin</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="versioned-data"><a class="header" href="#versioned-data">Versioned Data</a></h1>
<p>Currently <a href="https://irmin.org">Irmin</a> only supports <em>monomorphic</em> operations over stores, meaning there can
only be one return type from functions like <code>Store.get</code>. On the way to heterogeneity, a logical
first stop is being able to <em>version</em> content datatypes.</p>
<p>Versioning in this sense relates to the type and not the value. Irmin let's you version OCaml values,
but we want to have different versions of the type of that value whilst still preserving key
characteristics of the Irmin store.</p>
<h2 id="changing-the-content-type"><a class="header" href="#changing-the-content-type">Changing the Content Type</a></h2>
<p>Before we do that, let's first look at how it can go wrong. First let's define two types that are meant
to represent the same value but just one version is newer and has added new fields.</p>
<!-- $MDX file=bad-content-store/main.ml,part=contents -->
<pre><code class="language-ocaml">module C1 = struct
  type t = { name : string } [@@deriving irmin]

  let merge = Irmin.Merge.(option @@ default t)
end

module C2 = struct
  type t = { name : string; age : int }[@@deriving irmin]

  let merge = Irmin.Merge.(option @@ default t)
end
</code></pre>
<p>The only difference between the two types is the extra <code>age : int</code> field in <code>C2.t</code>. We can instantiate two Irmin
key-value stores that use the filesystem.</p>
<!-- $MDX file=bad-content-store/main.ml,part=stores -->
<pre><code class="language-ocaml">module S1 = Irmin_fs_unix.KV.Make (C1)
module S2 = Irmin_fs_unix.KV.Make (C2)
</code></pre>
<p>And now we can store a <code>C1.t</code> in the store and try and read it back using the <code>S2</code> interface.</p>
<!-- $MDX file=bad-content-store/main.ml,part=main -->
<pre><code class="language-ocaml">let main () =
  let conf = Irmin_fs.config &quot;./tmp&quot; in
  let* repo = S1.Repo.v conf in
  let* main = S1.main repo in
  let* () = S1.set_exn ~info main [ &quot;a&quot; ] C1.{ name = &quot;Alice&quot; } in
  let* repo = S2.Repo.v conf in
  let* main = S2.main repo in
  let* v = S2.get main [ &quot;a&quot; ] in
  Fmt.pr &quot;Name: %s&quot; v.name;
  Lwt.return_unit
</code></pre>
<p>But this goes wrong if we try running it!</p>
<pre><code class="language-sh">$ ./bad-content-store/main.exe
Fatal error: exception Irmin.Tree.find_all: encountered dangling hash 15942488a5c800c506817379631ace9263149cf42b0c8bc409a5a6e9698d6e5194ff6d178365e1642d9b5b29dee30ed18e5b4605c281a35db7d214428bfff510
[2]
</code></pre>
<h2 id="using-views"><a class="header" href="#using-views">Using Views</a></h2>
<p>The following is courtesy of <a href="https://github.com/samoht">Thomas Gazagnaire</a>.</p>
<h3 id="raw-views"><a class="header" href="#raw-views">Raw views</a></h3>
<p>One way to fix this problem is to abstract the content type behind a view on it. This view
let's us hide some details to the end user whilst giving us the power to do more complex manipulations
of the data we are storing. To begin with, the view contains information about the version of the data.</p>
<!-- $MDX file=views/main.ml,part=raw-types -->
<pre><code class="language-ocaml">  type v1 = { age : int } [@@deriving irmin ~pre_hash]
  type v2 = { age : int; name : string } [@@deriving irmin ~pre_hash]

  type t = V1 of v1 | V2 of v2 [@@deriving irmin]

  (* change depending on what you want to index - here we just skip the
     version field. Can only hash the age (but that will merge values
     with the same hash, so it's not a great index here). *)
  let pre_hash = function
    | V1 v -&gt; pre_hash_v1 v
    | V2 v -&gt; pre_hash_v2 v

  let t = Irmin.Type.like ~pre_hash t
</code></pre>
<p>This code handles serialising the version information so we can re-use that later without polluting
the content-addressable storage with fields we might not have later. For example, a user might only
habe their <code>age</code> and not be aware of the <code>V1</code> version number, but they don't need to be aware of it
for us to do content-addressed lookups for the data.</p>
<p>However, we do need to manage smooth upgrades and downgrades from the versions but this is only verbose,
not complicated.</p>
<!-- $MDX file=views/main.ml,part=raw-helpers -->
<pre><code class="language-ocaml">  let default_name = &quot;Default Name&quot;
  let v1 age = { age }
  let v2 ?(name = default_name) age = { age; name }
  let v1_to_v2 : v1 -&gt; v2 = fun { age } -&gt; v2 age
  let v2_to_v1 : v2 -&gt; v1 = fun { age; _ } -&gt; { age }
  let to_v2 = function V1 v -&gt; v1_to_v2 v | V2 v -&gt; v
  let to_v1 = function V1 v -&gt; v | (V2 _) as v -&gt; v2_to_v1 (to_v2 v)
  let merge_v1 = Irmin.Merge.(default v1_t)
  let merge_v2 = Irmin.Merge.(default v2_t)
</code></pre>
<p>Finally, we need to define a sufficient default merge function over versioned data.</p>
<!-- $MDX file=views/main.ml,part=raw-merge -->
<pre><code class="language-ocaml">  let merge : t Irmin.Merge.t =
    let open Lwt_result.Infix in
    let promise x = Irmin.Merge.promise x in
    let upgrade x = V2 (to_v2 x) in
    let wrap_v1 v = V1 v in
    let wrap_v2 v = V2 v in
    let rec f ~old x y =
      old () &gt;&gt;= fun old -&gt;
      match (old, x, y) with
      | Some (V1 old), V1 x, V1 y -&gt;
          Irmin.Merge.f merge_v1 ~old:(promise old) x y &gt;|= wrap_v1
      | Some (V2 old), V2 x, V2 y -&gt;
          Irmin.Merge.f merge_v2 ~old:(promise old) x y &gt;|= wrap_v2
      | _ -&gt;
          let old =
            match old with
            | None -&gt; fun () -&gt; Lwt.return (Ok None)
            | Some old -&gt; promise (upgrade old)
          in
          f ~old (upgrade x) (upgrade y)
    in
    Irmin.Merge.seq [ Irmin.Merge.default t; Irmin.Merge.v t f ]
</code></pre>
<h3 id="higher-level-abstraction"><a class="header" href="#higher-level-abstraction">Higher-level Abstraction</a></h3>
<p>With our raw views we can now provide a higher-level abstraction to use within our actual Irmin stores.</p>
<!-- $MDX file=views/main.ml,part=view -->
<pre><code class="language-ocaml">type 'a view = { payload : 'a; raw : Raw.t }

let version v = match v.raw with V1 _ -&gt; 1 | V2 _ -&gt; 2

module C1 = struct
  type t = Raw.v1 view

  let of_raw raw =
    let payload = Raw.to_v1 raw in
    { payload; raw }

  let to_raw t = t.raw
  let t = Irmin.Type.map Raw.t of_raw to_raw

  let v age =
    let v = Raw.v1 age in
    { payload = v; raw = V1 v }

  let merge = Irmin.Merge.(option @@ like t Raw.merge to_raw of_raw)
end
</code></pre>
<p>To be concise only <code>V1</code> is shown here but as you can see it reuses all of the <code>Raw</code> values we defined
previously. We can always convert to and from an <code>Raw.t</code> and that is how the runtime value <code>t</code> is defined.
This means if we pull a <code>V2</code> out of the store but the serialised version is a <code>V1</code> we can still deserialise it.</p>
<p>We can use these <code>Content</code> modules for stores now.</p>
<!-- $MDX file=views/main.ml,part=stores -->
<pre><code class="language-ocaml">module S1 = Irmin_fs_unix.KV.Make (C1)
module S2 = Irmin_fs_unix.KV.Make (C2)
</code></pre>
<p>And finally write a program where we interleave the stores, reading old and new values as we go!</p>
<!-- $MDX file=views/main.ml,part=main -->
<pre><code class="language-ocaml">let main () =
  let config = Irmin_fs.config &quot;./tmp2&quot; in
  let* repo = S1.Repo.v config in
  let* main = S1.main repo in
  let* repo2 = S2.Repo.v config in
  let* main2 = S2.main repo2 in
  let c1 = C1.v 42 in
  let _h1 = S1.Contents.hash c1 in
  let* () = S1.set_exn ~info:info1 main [ &quot;a&quot; ] c1 in
  Fmt.pr &quot;Storing S1 at a: { age = %i }\n%!&quot; c1.payload.age;
  let* v1 = S1.get main [ &quot;a&quot; ] in
  Fmt.pr &quot;S1 lookup a: %i (version = %d)\n%!&quot; v1.payload.age (version v1);
  let* v2 = S2.get main2 [ &quot;a&quot; ] in
  Fmt.pr &quot;S2 lookup a: %i (version = %d)\n%!&quot; v2.payload.age (version v2);
  let c2 = C2.v 43 ~name:&quot;Alice&quot; in
  let* () = S2.set_exn ~info:info2 main2 [ &quot;b&quot; ] c2 in
  Fmt.pr &quot;Storing S2 at b: { age = %i; name = %s }\n%!&quot; c2.payload.age c2.payload.name;
  let* v = S2.get main2 [ &quot;a&quot; ] in
  Fmt.pr &quot;S2 lookup a: %s %i (version = %d)\n%!&quot; v.payload.name v.payload.age
    (version v);
  let* v = S1.get main [ &quot;b&quot; ] in
  Fmt.pr &quot;S1 lookup b for age: %i\n%!&quot; v.payload.age;
  Lwt.return_unit
</code></pre>
<p>Let's run the program!</p>
<pre><code class="language-sh">$ ./views/main.exe
Storing S1 at a: { age = 42 }
S1 lookup a: 42 (version = 1)
S2 lookup a: 42 (version = 1)
Storing S2 at b: { age = 43; name = Alice }
S2 lookup a: Default Name 42 (version = 1)
S1 lookup b for age: 43
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../contents/json-at-rest.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../sync.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../contents/json-at-rest.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../sync.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script>
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>
        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
